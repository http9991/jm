Strophe.addConnectionPlugin("register",{_connection:null,init:function(e){this._connection=e;var t=0;Object.keys(Strophe.Status).forEach(function(e){t=Math.max(t,Strophe.Status[e])}),Strophe.addNamespace("REGISTER","jabber:iq:register"),Strophe.Status.REGIFAIL=t+1,Strophe.Status.REGISTER=t+2,Strophe.Status.REGISTERED=t+3,Strophe.Status.CONFLICT=t+4,Strophe.Status.NOTACCEPTABLE=t+5,e.disco&&(e.disco.addFeature&&e.disco.addFeature(Strophe.NS.REGISTER),e.disco.addNode&&e.disco.addNode(Strophe.NS.REGISTER,{items:[]}));var n=this,i=e.reset.bind(e);e.reset=function(){i(),n.instructions="",n.fields={},n.registered=!1};var s=e._connect_cb.bind(e);e._connect_cb=function(t,i,r){if(n._registering)n._connect_cb_data={req:t,raw:r},n._register_cb(t,i,r)&&(n.processed_features=!0,delete n._registering);else if(n.processed_features){var o=e.xmlInput;e.xmlInput=Strophe.Connection.prototype.xmlInput;var a=e.rawInput;e.rawInput=Strophe.Connection.prototype.rawInput,s(t,i,r),e.xmlInput=o,e.rawInput=a,delete n.processed_features}else s(t,i,r)};var r=e.authenticate.bind(e);e.authenticate=function(e){if("undefined"==typeof e){var t=this._connection;if(!this.fields.username||!this.domain||!this.fields.password)return void Strophe.info("Register a JID first!");var n=this.fields.username+"@"+this.domain;t.jid=n,t.authzid=Strophe.getBareJidFromJid(t.jid),t.authcid=Strophe.getNodeFromJid(t.jid),t.pass=this.fields.password;var i=this._connect_cb_data.req,s=t.connect_callback,o=this._connect_cb_data.raw;t._connect_cb(i,s,o)}else r(e)}.bind(this)},connect:function(e,t,n,i,s){var r=this._connection;this.domain=Strophe.getDomainFromJid(e),this.instructions="",this.fields={},this.registered=!1,this._registering=!0,r.connect(this.domain,"",t,n,i,s)},_register_cb:function(e,t,n){var i=this._connection;Strophe.info("_register_cb was called"),i.connected=!0;var s=i._proto._reqToData(e);if(s){i.xmlInput!==Strophe.Connection.prototype.xmlInput&&i.xmlInput(s.nodeName===i._proto.strip&&s.childNodes.length?s.childNodes[0]:s),i.rawInput!==Strophe.Connection.prototype.rawInput&&i.rawInput(n?n:Strophe.serialize(s));var r=i._proto._connect_cb(s);if(r===Strophe.Status.CONNFAIL)return!1;var o=s.getElementsByTagName("register"),a=s.getElementsByTagName("mechanism");return 0===o.length&&0===a.length?(i._proto._no_auth_received(t),!1):0===o.length?(i._changeConnectStatus(Strophe.Status.REGIFAIL,null),!0):(i._addSysHandler(this._get_register_cb.bind(this),null,"iq",null,null),i.send($iq({type:"get"}).c("query",{xmlns:Strophe.NS.REGISTER}).tree()),!0)}},_get_register_cb:function(e){var t,n,i,s=this._connection;if(n=e.getElementsByTagName("query"),1!==n.length)return s._changeConnectStatus(Strophe.Status.REGIFAIL,"unknown"),!1;for(n=n[0],t=0;t<n.childNodes.length;t++)i=n.childNodes[t],"instructions"!==i.tagName.toLowerCase()?"x"!==i.tagName.toLowerCase()&&(s.register.fields[i.tagName.toLowerCase()]=Strophe.getText(i)):s.register.instructions=Strophe.getText(i);return s._changeConnectStatus(Strophe.Status.REGISTER,null),!1},submit:function(){var e,t,n,i,s=this._connection;for(n=$iq({type:"set"}).c("query",{xmlns:Strophe.NS.REGISTER}),i=Object.keys(this.fields),e=0;e<i.length;e++)t=i[e],n.c(t).t(this.fields[t]).up();s._addSysHandler(this._submit_cb.bind(this),null,"iq",null,null),s.send(n)},_submit_cb:function(e){var t,n,i,s=null,r=this._connection;if(n=e.getElementsByTagName("query"),n.length>0)for(n=n[0],t=0;t<n.childNodes.length;t++)i=n.childNodes[t],"instructions"!==i.tagName.toLowerCase()?this.fields[i.tagName.toLowerCase()]=Strophe.getText(i):this.instructions=Strophe.getText(i);if("error"===e.getAttribute("type")){if(s=e.getElementsByTagName("error"),1!==s.length)return r._changeConnectStatus(Strophe.Status.REGIFAIL,"unknown"),!1;Strophe.info("Registration failed."),s=s[0].firstChild.tagName.toLowerCase(),"conflict"===s?r._changeConnectStatus(Strophe.Status.CONFLICT,s):"not-acceptable"===s?r._changeConnectStatus(Strophe.Status.NOTACCEPTABLE,s):r._changeConnectStatus(Strophe.Status.REGIFAIL,s)}else Strophe.info("Registration successful."),r._changeConnectStatus(Strophe.Status.REGISTERED,null);return!1}});